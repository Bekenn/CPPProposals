\documentclass{wg21}

\usepackage{xcolor}
\usepackage{soul}
\usepackage{ulem}
\usepackage{fullpage}
\usepackage{parskip}
\usepackage{csquotes}
\usepackage{relsize}      % provide relative font size changes
\usepackage{textcomp}     % provide \text{l,r}angle
\usepackage{mathrsfs}     % mathscr font

\title{Unifying \tcode{source\_location} and \tcode{contract\_violation}}
\docnumber{D163PR0}
\audience{LEWG, LWG}
\author{Corentin Jabot}{corentin.jabot@gmail.com}

\begin{document}
\maketitle

\section{Proposed change}

We propose that \tcode{contract\_violation} uses \tcode{source\_location}
to report the location where a contract violation happens.
The goal is to avoid API duplication and to make it easier to log contract violations
in systems designed around  \tcode{source\_location}.

This modification matches the original intent of \cite{P0542} as discussed in Kona 2017.


Note that \tcode{source\_location::file\_name} and \tcode{source\_location::function\_name}
return a \tcode{const char*} unlike \tcode{contract\_violation} whose \tcode{function\_name}
and \tcode{file\_name} return a \tcode{string_view}.
However, while LEWG has reaffirmed several times the design of \tcode{source\_location},
we found no explanation why \tcode{contract\_violation} is diverging from that design and
the reasoning motivating \tcode{source\_location}'s design equally applies  to \tcode{contract\_violation}.

Moreover, the same logic can be applied to \tcode{contract\_violation::comment} and \tcode{contract\_violation::assertion}.
This have been discussed at length on the reflector, a few conclusions being that

\begin{itemize}
	\item (Unfortunately) most system apis are designed around null-terminated strings
	\item \tcode{string\_view} therefore removes useful information from the underlying string
	\item Despite null-termination being a runtime property in the general case, it would be ABI breaking to efficiently adapt \tcode{string\_view} to track and query the null termination of the underlying string.
	\item In the absence of a way to query null-termination, assuming it is as best UB and a terrible practice, notably teaching-wise
	\item Adding a new null-terminated \tcode{czstring\_view} type doesn't have consensus and even if it did, it raises a number of issues as how to manage an already complex overload set.
	\item It is unlikely we will find the best path forward in the C++20 time frame
	\item There are concerns that \tcode{string\_view} might not be implementable in a freestanding implementation, which is a major issue since \tcode{contract\_violation} supports a language feature.
\end{itemize}

Several other concerns related to the compilation costs of including and using \tcode{string\_view} have been raised, however, I do not believe these concerns hold much ground in the long run as modules are supposed to solve this issue.
Besides, forgoing type safety for compilation speed would set an interesting precedent...

Nevertheless, there seem to be enough issues with \tcode{string\_view} that it seems
preferable not to use it as a return parameter of \tcode{contract\_violation} methods.
It is possible that \tcode{string\_view} might never be a good type to return from a function.





\section{Applicability}

This papers depends on \cite{P1208} being accepted by LWG.
It has have been accepted by LEWG in Kona 2019.

\section{Wording}

\rSec2[support.contract.cviol]{Class \tcode{contract_violation}}
\indexlibrary{\idxcode{contract_violation}}%

\begin{codeblock}
	namespace std {
		class contract_violation {
			public:
			@\removed{uint_least32_t line_number() const noexcept;}@
			@\removed{string_view file_name() const noexcept;}@
			@\removed{string_view function_name() const noexcept;}@
			@\added{source_location location() const noexcept;}@
			@\changed{string_view}{const char*}@ comment() const noexcept;
			@\changed{string_view}{const char*}@ assertion_level() const noexcept;
		};
	}
\end{codeblock}

\pnum
The class \tcode{contract_violation} describes information about
a contract violation generated by the implementation.

\begin{removedblock}
\begin{itemdecl}
	uint_least32_t line_number() const noexcept;
\end{itemdecl}

\begin{itemdescr}
	\pnum
	\returns The source code location
	where the contract violation happened\iref{dcl.attr.contract}.
	If the location is unknown, an implementation may return \tcode{0}.
\end{itemdescr}

\indexlibrarymember{file_name}{contract_violation}%
\begin{itemdecl}
	string_view file_name() const noexcept;
\end{itemdecl}

\begin{itemdescr}
	\pnum
	\returns The source file name
	where the contract violation happened\iref{dcl.attr.contract}.
	If the file name is unknown,
	an implementation may return \tcode{string_view\{\}}.
\end{itemdescr}

\indexlibrarymember{function_name}{contract_violation}%
\begin{itemdecl}
	string_view function_name() const noexcept;
\end{itemdecl}

\begin{itemdescr}
	\pnum
	\returns The name of the function
	where the contract violation happened\iref{dcl.attr.contract}.
	If the function name is unknown,
	an implementation may return \tcode{string_view\{\}}.
\end{itemdescr}

\end{removedblock}

\begin{addedblock}
\begin{itemdecl}
	source_location location() const noexcept;
\end{itemdecl}

\begin{itemdescr}
	\pnum
	\returns The source code location
	where the contract violation happened.
	If the location is unknown, an implementation may return a default constructed \tcode{source\_location}.
\end{itemdescr}
\end{addedblock}

\indexlibrarymember{comment}{contract_violation}%
\begin{itemdecl}
	@\changed{string_view}{const char*}@ comment() const noexcept;
\end{itemdecl}

\begin{itemdescr}
	\pnum
	\returns Implementation-defined text describing
	the predicate of the violated contract.
\end{itemdescr}

\indexlibrarymember{assertion_level}{contract_violation}%
\begin{itemdecl}
	@\changed{string_view}{const char*}@ assertion_level() const noexcept;
\end{itemdecl}

\begin{itemdescr}
	\pnum
	\returns Text describing the \grammarterm{assertion-level}
	of the violated contract.
\end{itemdescr}


\begin{thebibliography}{9}
	
	\bibitem[P0542]{P0542}
	G. Dos Reis, J. D. Garcia, J. Lakos, A. Meredith, N. Myers, B. Stroustrup
	\emph{Support for contract based programming in C++}
	\url{https://wg21.link/P0542}
	
	\bibitem[P1208]{P1208}
	Robert Douglas, Corentin Jabot
	\emph{Adopt source location from Library Fundamentals V3 for C++20}
	\url{https://wg21.link/P1208}		
	
\end{thebibliography}

\end{document}